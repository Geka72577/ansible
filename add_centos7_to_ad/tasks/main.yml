---
# tasks file for add_centos7_to_ad

  - name: Find name of network interface
    shell: "ip -o link show | awk -F': ' '{print $2}' | grep -i ^e | head -1"
    register: output_interface

  - name: Ensure that the variable PEERDNS set in "yes"
    lineinfile:
     path: /etc/sysconfig/network-scripts/ifcfg-{{ output_interface.stdout }}
     regexp: '^PEERDNS'
     line: PEERDNS=yes
    register: output_peerdns

  - name: Specify DNS1
    lineinfile:
     path: /etc/sysconfig/network-scripts/ifcfg-{{ output_interface.stdout }}
     regexp: '^DNS1'
     line: DNS1={{ DNS1 }} 
    register: output_dns1
    when: DNS1 is defined

  - name: Specify DNS2
    lineinfile:
     path: /etc/sysconfig/network-scripts/ifcfg-{{ output_interface.stdout }}
     regexp: '^DNS2'
     line: DNS2={{ DNS2 }} 
    register: output_dns2
    when: DNS2 is defined

  - name: restart network interface
    service:
     name: network
     state: restarted
    when: output_peerdns.changed == true or output_dns1.changed == true or output_dns2.changed == true

  - name: install packages
    include_tasks: install.j2
    loop: "{{package_for_install}}"

  - name: Check if the instance in the Active Directory
    command: id {{ user_ad }}@{{ domain_ad }}
    register: result
    ignore_errors: yes
   
  - block:

    - name: Join the instance to the Active Directory
      shell: echo {{ user_ad_password }} | realm join -U {{ user_ad }}@{{ domain_ad }} {{ domain_ad }}  --verbose
      register: output

    - name: "Result of joining"
      debug:
        var: output.stderr
    when: result.rc != 0

  - name: Check if SSH service to allow password authentication
    command: grep ^'PasswordAuthentication[[:blank:]]*yes' /etc/ssh/sshd_config
    register: result_ssh
    ignore_errors: yes

  - name: Set the SSH service to allow password authentication
    lineinfile:
     path: '/etc/ssh/sshd_config'
     regexp: '^PasswordAuthentication'
     line:  'PasswordAuthentication yes'
    notify: 'Restart service sshd'
    when: result_ssh.rc != 0

  - name: Change variable in sssd file
    lineinfile:
     dest: '/etc/sssd/sssd.conf'
     regexp: '^use_fully_qualified_names '
     line:  'use_fully_qualified_names = False'
    notify: 'Restart service sssd'

  - name: Specify in sssd file who may login
    lineinfile:
     path: '/etc/sssd/sssd.conf'
     state: present
     line:  "{{ ad_access_filter }}"
    notify: 'Restart service sssd'

  - name: Add comment to sudoers file and  validate with saving
    lineinfile:
      path: /etc/sudoers
      state: present
      line: '## Add the "AWS Delegated Administrators" group from the example.com domain.'
      validate: /usr/sbin/visudo -cf %s

  - name: Add permissions for AD users and validate savings
    lineinfile:
      path: /etc/sudoers
      state: present
      line: "{{ group_ad }}"
      validate: /usr/sbin/visudo -cf %s

  - name: Check if the host was added to AD
    command: id {{ user_ad }}@{{ domain_ad }}
    register: finish_result 
    ignore_errors: yes
  
  - debug:
     msg:  "RESULT: Host {{ ansible_hostname }} with {{ ansible_default_ipv4.address }} was added to AD successfully"
    when: finish_result.rc == 0 

  - debug:
     msg:  "RESULT: Host {{ ansible_hostname }} with {{ ansible_default_ipv4.address }} wasn't added to AD successfully"
    when: finish_result.rc != 0
